<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>服装公社</title>
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <script src="../js/mui.min.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <link href="../css/mui.picker.min.css" rel="stylesheet"/>
    <link href="../css/mui.poppicker.css" rel="stylesheet"/>
    <script type="text/javascript" charset="utf-8">
        mui.init();
    </script>
</head>
<body>
<header class="mui-bar mui-bar-nav"> <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" href="../index.html" ></a>
    <h1 class="mui-title">寻找拉腰拉条司马克接活发布</h1>
    </div>
</header>
<div class="mui-content">
    <form class="mui-input-group" id="addForm" style=" background:none;">
        <div class="mui-view">
            <div class="mui-input-row">
                <input type="text" placeholder="标题" maxlength="15" name="title" id="title">
            </div>
            <div class="mui-input-row mui-input-row-end" >
                <textarea id="textarea" rows="5" placeholder="请输入内容" name="intro"></textarea>
            </div>
        </div>

        <div class="mui-view" style="padding:15px 15px;">
            <div class="mui-imglist">
                <div class="mui-icon mui-icon-plusempty" id="uploads"></div>
                <div class="clear"></div>
            </div>
        </div>
        <div class="mui-view">
        	<div class="mui-input-row">
                <label>加工项目</label>
                <select name="param[project]" id="project"></select>
            </div>
            <div class=" mui-button-row " style="text-align: center;clear: both;" id="view">
        		<button type="button"  onclick="machine()" class="mui-btn mui-btn-info" style="width:90%;lear: both;">添加</button>
        	</div>
            <div class="mui-input-row">
                <label>员工人数</label>
                <input class="mui-input-numbox" type="number" name="param[employee_num]" id="employee_num" />
            </div>
            <div class="mui-input-row">
                <label >可接活时间</label>
                <input type="text" class="mui-input-clear" name="param[date_start]" data-options="{&quot;type&quot;:&quot;date&quot;,&quot;beginYear&quot;:2018,&quot;endYear&quot;:3000}" placeholder="可接活时间" data-input-clear="5" id="mui-jh-date">
            </div>
            <div class="mui-input-row">
                <label>工厂地址</label>
                <input type="hidden" name="province" id="province">
                <input type="hidden" name="city" id="city">
                <input type="hidden" name="county" id="county">
                <input type="text" class="mui-input-clear" placeholder="地址" name="address" data-input-clear="5" id="mui-address">
                <span class="mui-icon mui-icon-clear mui-hidden"></span> </div>
            <div class="mui-input-row">
                <label>联系人</label>
                <input type="text" class="mui-input-clear" placeholder="联系人" name="link" id="link" data-input-clear="5">
                <span class="mui-icon mui-icon-clear mui-hidden"></span> </div>
            <div class="mui-input-row">
                <label>电话</label>
                <input type="text" class="mui-input-clear" placeholder="电话" data-input-clear="5" name="phone" id="phone">
                <span class="mui-icon mui-icon-clear mui-hidden"></span> </div>
            <div class="mui-button-row">
				<button type="button" class="mui-btn mui-btn-danger" onclick="javascript:history.go(-1);" style="width:auto; ">返回</button>&nbsp;&nbsp;
	            <button type="button" data-loading-text="发布中" onclick="addEvent()" class="mui-btn mui-btn-primary" style="width:auto;">发布</button>
            </div>
        </div>
        <input type="hidden" name="thumb_images" id="thumb_images">
        <input type="hidden" name="images" id="images">
        <input type="hidden" name="model" value="11">
        <input type="hidden" name="type" value="2">
        <input type="hidden" name="user" id="user" value="">
        <input type="hidden" name="target[province]" />
      <input type="hidden" name="target[city]" />
      <input type="hidden" name="target[county]" />
      <input type="hidden" name="id" id="id" />
      <input type="hidden" name="version" id="version" />
    </form>
</div>

<nav class="mui-bar mui-bar-tab">
    <a class="mui-tab-item mui-active" href="../index.html">
        <span class="mui-icon mui-icon-home"></span>
        <span class="mui-tab-label">首页</span>
    </a>
    <a class="mui-tab-item" href="../extension.html">
        <span class="mui-icon mui-icon-plusempty"></span>
        <span class="mui-tab-label" style="padding-top:25px;">我要推广</span>
    </a>

    <a class="mui-tab-item" href="../user.html">
        <span class="mui-icon mui-icon mui-icon-contact"></span>
        <span class="mui-tab-label">我的</span>
    </a>
</nav>

<script src="../js/jquery-3.2.1.min.js"></script>
<script src="../js/mui.picker.min.js"></script>
<script src="../js/mui.poppicker.js"></script>
<script src="../js/city.data.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/public.js"></script>
<script src="../layui/layui.js"></script>
<script src="../js/config.js"></script>
<script src="../js/otcms.js"></script>
<script src="../js/common.js"></script>
<script>
    (function($, doc) {
        $.init();
        $.ready(function() {
        	var date = new Date();
            var dateButton=doc.getElementById('mui-jh-date');
            dateButton.addEventListener('tap', function() {
                var optionsJson = {
                	type : 'date',
                	beginYear : date.getFullYear(),
                	endYear : date.getFullYear() + 5
                };
                var id = this.getAttribute('id');

                var picker = new $.DtPicker(optionsJson);
                picker.show(function(rs) {
                    dateButton.value=rs.text;
                    picker.dispose();
                });
            }, false);

        });
    })(mui, document);
	var index = 0;
    $(function () {
        var user_id = window.localStorage.getItem('user_id');
        if(user_id == null){
            window.location = '../login.html';
            return false;
        }
        $('#user').val(user_id);
        machine();
        initProject();
        var id = $('#id').val();
		if(id > 0){
			edit(id);
		}
    });
    //初始化设备类型
    function machine(){
    	eval('var cates =' + window.localStorage.getItem('machType'));
    	var op = '';
    	for(var c in cates){
    		op += '<option value="'+c+'">'+cates[c]+'</option>';
    	}
    	var html = '';
		html += '<div class="mui-input-row">';
		html += '<label><select name="machineType[]" class="mui-input-clear">'+op+'</select></label>';
		html += '<span style="float:left;color:#000000">数量</span>';
		html += '<input class="mui-input-numbox" type="number" style="width:50px;float:left;" id="m_type'+index+'" name="machine[]" />';
		html += '<span style="float:left;color:#000000">台</span>';
		html += '<span onclick="removeItem(this)" style="float:left;padding-left:0;color:#ffffff;width:15%;text-align:center;border-radius:10px;" class="mui-btn-danger">移除</span>';
		html += '</div>';
    	$('#view').before(html);
    	index++;
    }
    //移除
    function removeItem(obj){
    	$(obj).parent().remove();
    }
    //加工项目
   	function initProject(){
   		eval('var pros =' + window.localStorage.getItem('project'));
   		var html = '';
   		for(var p in pros){
   			html += '<option value="'+p+'">'+pros[p]+'</option>';
   		}
   		$('#project').html(html);
   	}
    //添加
    function addEvent() {
        var title = $('#title').val(),
        	employee_num = $('#employee_num').val(),
        	date_start = $('#mui-jh-date').val(),
            link = $('#link').val(),
            address = $('#mui-address').val(),
        	phone = $('#phone').val();
        if(title == '') {
            mui.toast('标题必须填写!'); return false;
        }
        if(images_arr.length == 0){
            mui.toast('请上传图片'); return false;
        }
        if(employee_num == '' || employee_num <= 0){
        	mui.toast('员工数量必须大于0!');
        	return false;
        }
        if(date_start == '') {
        	mui.toast('可接活时间不能为空!');
        	return false;
        }
        //判断设备类型和设备数量
        var flag = false;
        var arr = $('input[name="machine[]"]');
        for(var i=0;i<arr.length;++i){
        	var val = $(arr[i]).val();
        	if(val > 0) {
        		flag = true;
        	}
        }
        if(!flag){
        	mui.toast('设备数量必须填写');
        	return false;
        }
        
        if(address == ''){
        	mui.toast('地址不能为空');
        	return false;
        }
        if(link == '') {
        	mui.toast('联系人必须填写!');
        	return false;
        }
        if(hasPhone(link) == 1){
        	mui.toast('联系人不能含有手机号');
        	return false;
        }
        if(phone == ''){
        	mui.toast('手机号不能为空!');
        	return false;
        }

        $('#images').val(images_arr.join('|'));
        $('#thumb_images').val(thumb_arr.join('|'));
        var model = $('input[name=model]').val(),
            type = $('input[name=type]').val();
    	var url = 'list_1.html?model='+model+'&type='+type;
        $.post(host + '/work/add',$('#addForm').serialize(),function (data) {
            if(data.code == 1) {
                otcms.success('添加成功',url);
            }else {
                otcms.error(data.msg);
            }
        },'JSON');
    }
    mui('body').on('tap','a',function(){
        window.top.location.href=this.href;
    });
</script>
</body>
</html>
